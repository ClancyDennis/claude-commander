# Dockerfile for cross-compiling Claude Commander to Linux ARM64 from x86_64
# Run with: docker build -f scripts/Dockerfile.linux-arm64 .

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Enable ARM64 architecture for multiarch packages
RUN dpkg --add-architecture arm64

# Install system dependencies
RUN apt-get update && apt-get install -y \
    # Build essentials
    build-essential \
    curl \
    wget \
    git \
    pkg-config \
    # Cross-compilation tools
    gcc-aarch64-linux-gnu \
    g++-aarch64-linux-gnu \
    libc6-dev-arm64-cross \
    # Host Tauri/WebKit dependencies (for cargo to work)
    libwebkit2gtk-4.1-dev \
    libappindicator3-dev \
    librsvg2-dev \
    patchelf \
    libssl-dev \
    libgtk-3-dev \
    libayatana-appindicator3-dev \
    # ARM64 cross-compilation libraries
    libssl-dev:arm64 \
    # File utilities
    file \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20 LTS
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install Rust with ARM64 target
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
RUN rustup target add aarch64-unknown-linux-gnu

# Configure Cargo for cross-compilation
RUN mkdir -p /root/.cargo && \
    echo '[target.aarch64-unknown-linux-gnu]' >> /root/.cargo/config.toml && \
    echo 'linker = "aarch64-linux-gnu-gcc"' >> /root/.cargo/config.toml

# Set environment for cross-compilation
ENV PKG_CONFIG_SYSROOT_DIR=/usr/aarch64-linux-gnu
ENV PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
ENV CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc

WORKDIR /app

# Copy package files
COPY package*.json ./
RUN npm ci

# Copy the rest
COPY . .

# Build frontend
RUN npm run build

# Build for ARM64
# Note: Full Tauri cross-compilation to ARM64 requires additional setup
# This builds the Rust binary but may not include full bundle
WORKDIR /app/src-tauri
RUN cargo build --release --target aarch64-unknown-linux-gnu

# For full Tauri bundle, you'd need ARM64 GTK/WebKit libraries
# Consider using QEMU/buildx for full ARM64 builds instead
